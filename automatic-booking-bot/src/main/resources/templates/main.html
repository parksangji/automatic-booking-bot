<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta charset="UTF-8">
  <title th:text="${htmlPageTitle ?: 'Booking Dashboard'}">Booking Dashboard</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
  <link rel="stylesheet" th:href="@{/css/slidepanal.css}">
  <script th:inline="javascript">
    /*<![CDATA[*/
    window.csrfToken = /*[[${_csrf?.token}]]*/ null;
    window.csrfHeaderName = /*[[${_csrf?.parameterName}]]*/ null;
    window.baseUrl = /*[[@{/}]]*/ '/';
    window.flashOpenModalFor = /*[[${openModalFor}]]*/ null;
    window.flashModalBookingId = /*[[${modalBookingId}]]*/ null;
    window.flashModalBookingData = /*[[${modalBookingDataForScript}]]*/ null;
    window.flashBindingResultForBookingData = /*[[${#fields.hasErrors('bookingData')} ? ${#fields.detailedErrors('bookingData')} : null]]*/ null;
    /*]]>*/
  </script>
  <style>
    /* 기본 body 및 dashboard-container 스타일 */
    body {
      display: block;
      padding: 20px;
      background-color: #FDFBF6;
      font-family: 'Nunito', sans-serif;
      overflow-x: hidden; /* 좌측 하단 알림창 너비 문제 방지 */
    }
    .dashboard-container {
      max-width: 90%;
      width: 1200px;
      margin: 0 auto;
      background-color: #FFFFFF;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    /* 1. Page Header 수정: Welcome 메시지 Logout 버튼 옆으로 */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }
    .page-header h1.page-title { /* Dancing Script from style.css */
      font-family: 'Dancing Script', cursive;
      color: #8C7853;
      margin: 0;
      font-size: 2.5em;
      flex-grow: 1; /* 제목이 남은 공간 차지 */
    }
    .header-user-actions {
      display: flex;
      align-items: center;
    }
    .user-info { /* 기존 user-info 클래스 재활용 */
      margin-right: 20px; /* 로그아웃 버튼과의 간격 */
      font-size: 1.0em; /* 폰트 크기 조정 */
      color: #555; /* 텍스트 색상 */
      font-family: 'Nunito', sans-serif; /* 동글동글 글씨체 */
    }
    .user-info .username { /* 기존 스타일 유지 또는 Nunito 상속 */
      font-family: 'Dancing Script', cursive; /* 또는 'Nunito', sans-serif; 로 변경 가능 */
      color: #8C7853;
      font-size: 1.2em; /* 폰트 크기 조정 */
      font-weight: 600;
    }
    .page-header form { /* Logout form */
      margin: 0;
    }


    /* 2. "Add New Booking" 버튼 위치 변경 */
    .bookings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .bookings-header h2 { /* "My Current Bookings" 제목 */
      font-family: 'Dancing Script', cursive;
      color: #8C7853;
      font-size: 2.2em;
      margin: 0;
    }
    #addBookingBtn { /* 버튼 자체의 마진은 여기서 관리 */
      margin-bottom: 0; /* 기존 마진 제거 */
    }

    /* Page Header 단순화 */
    .page-header {
      display: flex;
      justify-content: space-between; /* 제목은 왼쪽, 버튼은 오른쪽 */
      align-items: center;
      margin-bottom: 30px; /* 간격 조정 */
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }
    .page-header h1.page-title {
      font-family: 'Dancing Script', cursive;
      color: #8C7853;
      margin: 0;
      font-size: 2.8em; /* 제목 크기 조정 */
    }
    .page-header form { margin: 0; } /* 로그아웃 폼 마진 제거 */

    /* "Add New Booking" 버튼 위치 및 크기 조정 */
    .bookings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px; /* 테이블과의 간격 */
    }
    .bookings-header h2 {
      font-family: 'Dancing Script', cursive;
      color: #8C7853;
      font-size: 2.2em;
      margin: 0;
    }
    /* "Add New Booking" 버튼 크기 축소 */
    #addBookingBtn {
      padding: 8px 18px; /* 패딩 줄이기 */
      font-size: 0.9em;  /* 폰트 크기 줄이기 */
      font-weight: 600;
      margin-bottom: 0;
      border-radius: 18px; /* 동글동글함 유지 */
    }

    /* 테이블 레이아웃 */
    .table-container { width: 100%; margin-top: 20px; overflow-x: auto; }
    table#bookingsTable { width: 100%; border-collapse: collapse; table-layout: auto; }
    table#bookingsTable th, table#bookingsTable td { text-align: left; padding: 12px 15px; border-bottom: 1px solid #eaeaea; font-family: 'Nunito', sans-serif; vertical-align: middle; white-space: nowrap; }
    table#bookingsTable th { background-color: #F8F0E3; color: #6F4E37; font-weight: 600; font-size: 0.9em; }
    table#bookingsTable td { font-size: 0.85em; color: #555; }
    table#bookingsTable th:last-child, table#bookingsTable td:last-child { width: auto; text-align: center; white-space: nowrap; }
    table#bookingsTable td .btn-sm { padding: 6px 12px; font-size: 0.8em; margin: 2px; border-radius: 15px; display: inline-block; }
    .status-active { color: #28a745; font-weight: bold; }
    .status-inactive { color: #6c757d; }

    /* 3. Alert 메시지 스타일 및 애니메이션 (좌측 하단 토스트) */
    .toast-alert {
      position: fixed;
      bottom: 20px;
      left: -400px; /* 초기에는 화면 왼쪽에 숨김 (너비 고려) */
      width: auto;
      max-width: 350px;
      padding: 15px 20px;
      margin-bottom: 0; /* 기존 .alert 마진 제거 */
      border: 1px solid transparent;
      border-radius: 8px; /* 좀 더 동글동글하게 */
      font-size: 0.9em;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 2000; /* 모달보다 위에 오도록 (모달 z-index 1050) */
      opacity: 0;
      transition: left 0.5s ease-in-out, opacity 0.5s ease-in-out; /* left와 opacity 트랜지션 */
    }
    .toast-alert.show {
      left: 20px; /* 화면 안으로 슬라이드 */
      opacity: 1;
    }
    .toast-alert.slide-out {
      left: -400px; /* 다시 화면 밖으로 슬라이드 */
      opacity: 0;
    }
    .toast-alert.alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
    .toast-alert.alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }


    /* Modal Styles (이전과 유사) */
    .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow-y: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center;}
    .modal-content-wrapper { background-color: #FFFFFF; margin: 5% auto; padding: 0; border-radius: 10px; width: 90%; max-width: 550px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; animation: fadeInModal 0.3s ease-out; }
    @keyframes fadeInModal { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
    .modal-header { padding: 20px 30px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;}
    .modal-header h2 { font-family: 'Dancing Script', cursive; color: #8C7853; margin:0; font-size:2.2em; }
    .modal-body { padding: 25px 30px 30px 30px; max-height: 70vh; overflow-y: auto; }
    .close-button { color: #888; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
    .close-button:hover, .close-button:focus { color: #333; text-decoration: none; }
    .modal-error { display: block; font-size: 0.85em; color: #C62828; margin-top: 4px; }
    .modal-body .form-group { margin-bottom: 15px; }
    .modal-body .btn { margin-top: 15px; }

    table#bookingsTable tbody tr {
      cursor: pointer;
    }
    table#bookingsTable tbody tr:hover {
      background-color: #f9f9f9; /* 호버 효과 */
    }
  </style>
</head>
<body>
<div class="dashboard-container">
  <div class="page-header">
    <h1 class="page-title" th:text="${pageHeaderTitle ?: 'Booking Dashboard'}">Booking Dashboard</h1>
    <form th:action="@{/logout}" method="post">
      <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />
      <button type="submit" class="btn btn-secondary">Logout</button>
    </form>
  </div>

  <div id="toastAlertContainer">
    <div th:if="${successMessage}" id="toastSuccessAlert" class="toast-alert alert-success" role="alert" th:text="${successMessage}"></div>
    <div th:if="${errorMessage}" id="toastErrorAlert" class="toast-alert alert-danger" role="alert" th:text="${errorMessage}"></div>
  </div>

  <div class="table-container">
    <div class="bookings-header">
      <h2>My Current Bookings</h2>
      <button id="addBookingBtn" class="btn btn-primary">Add New Booking</button>
    </div>

    <div th:if="${#lists.isEmpty(bookings)}">
      <p>No bookings found. Click "Add New Booking" to get started!</p>
    </div>
    <table id="bookingsTable" th:unless="${#lists.isEmpty(bookings)}">
      <thead>
      <tr>
        <th>Site Name</th>
        <th>Login ID</th>
        <th>Booking Time</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="booking : ${bookings}">
        <td th:text="${booking.siteName}">Site Alpha</td>
        <td th:text="${booking.loginId}">myIdForAlpha</td>
        <td th:text="${booking.displayBookingTime}">2025-05-20 10:00</td>
        <td>
          <span th:if="${booking.active}" class="status-active">Active</span>
          <span th:unless="${booking.active}" class="status-inactive">Inactive</span>
        </td>
        <td>
          <button type="button" class="btn btn-secondary btn-sm editBookingBtn" th:data-booking-id="${booking.id}">Edit</button>
          <form th:action="@{/bookings/{id}/delete(id=${booking.id})}" method="post" style="display: inline-block;" onsubmit="return confirm('Are you sure you want to delete this booking?');">
            <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />
            <button type="submit" class="btn btn-secondary btn-sm" style="background-color: #C62828; color: white;">Delete</button>
          </form>
          <form th:action="@{/bookings/{id}/toggle-status(id=${booking.id})}" method="post" style="display: inline-block;">
            <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />
            <button type="submit" class="btn btn-secondary btn-sm"
                    th:text="${booking.active ? 'Deactivate' : 'Activate'}"
                    th:style="${booking.active ? 'background-color: #D2B48C;' : 'background-color: #8C7853;'} + 'color: white;'">
            </button>
          </form>
          <button type="button" class="btn btn-info btn-sm viewDetailsBtn" th:data-booking-id="${booking.id}">Details</button>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<div id="bookingModal" class="modal">
  <div class="modal-content-wrapper">
    <div class="modal-header">
      <h2 id="modalTitle">Booking</h2>
      <span id="closeModalBtn" class="close-button">&times;</span>
    </div>
    <div class="modal-body" id="bookingModalBody">
      <p>Loading form...</p>
    </div>
  </div>
</div>

<script th:src="@{/js/main.js}"></script>
<script th:src="@{/js/slidepanal.js}"></script>
</body>
</html>